app = customtkinter.CTk()
app.title("Crawl FL Ig")
app.geometry("350x380")

def stop():
    pass

def check_status():
    d = 0
    if len(list_username)==0:
        frame_text_box.configure(state = "normal")
        frame_text_box.insert(customtkinter.END, f'Vui lòng nhập file username\n')
        frame_text_box.configure(state = "disabled")
        d+=1
    if len(list_userpass)==0:
        frame_text_box.configure(state = "normal")
        frame_text_box.insert(customtkinter.END, f'Vui lòng nhập file account\n')
        frame_text_box.configure(state = "disabled")
        d+=1
    try:
        check = int(delay.get())
    except:
        frame_text_box.configure(state = "normal")
        frame_text_box.insert(customtkinter.END, f'Vui lòng nhập đúng định dạng của delay\n')
        frame_text_box.configure(state = "disabled")
        d+=1
    try:
        check = int(change_account.get())
    except:
        frame_text_box.configure(state = "normal")
        frame_text_box.insert(customtkinter.END, f'Vui lòng nhập đúng định dạng của số acc change để crawl\n')
        frame_text_box.configure(state = "disabled")
        d+=1
    if d>0: return False
    else: return True

def start():
    def get_cookie(user, pss):
        global ck_insta, token_insta
        def password_encrypt(password):
            publickeyid, publickey = password_publickeys()
            session_key = get_random_bytes(32)
            iv = get_random_bytes(12)
            timestamp = str(int(time.time()))
            decoded_publickey = base64.b64decode(publickey.encode())
            recipient_key = RSA.import_key(decoded_publickey)
            cipher_rsa = PKCS1_v1_5.new(recipient_key)
            rsa_encrypted = cipher_rsa.encrypt(session_key)
            cipher_aes = AES.new(session_key, AES.MODE_GCM, iv)
            cipher_aes.update(timestamp.encode())
            aes_encrypted, tag = cipher_aes.encrypt_and_digest(password.encode("utf8"))
            size_buffer = len(rsa_encrypted).to_bytes(2, byteorder="little")
            payload = base64.b64encode(
                b"".join(
                    [
                        b"\x01",
                        publickeyid.to_bytes(1, byteorder="big"),
                        iv,
                        size_buffer,
                        rsa_encrypted,
                        tag,
                        aes_encrypted,
                    ]
                )
            )
            return f"#PWD_INSTAGRAM:4:{timestamp}:{payload.decode()}"

        def password_publickeys():
            resp = requests.get("https://i.instagram.com/api/v1/qe/sync/")
            publickeyid = int(resp.headers.get("ig-set-password-encryption-key-id"))
            publickey = resp.headers.get("ig-set-password-encryption-pub-key")
            return publickeyid, publickey
        s = requests.session()
        s.get("https://www.instagram.com")
        token_insta = s.cookies.get ("csrftoken")
        header={
        "x-csrftoken":token_insta,
        "user-agent":"Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/121.0.0.0 Safari/537.36 Edg/121.0.0.0"
        }

        data = {
        "enc_password": password_encrypt(pss),
        "username": user,
        "queryParams": {}
        }
        r = s.post("https://www.instagram.com/accounts/login/ajax/",data=data, headers=header)
        print(r.text)
        try:
            if str(r.json()["authenticated"]) == "False":
                frame_text_box.configure(state = "normal")
                frame_text_box.insert(customtkinter.END, f'Login không thành công account {user}\n')
                frame_text_box.configure(state = "disabled")
                return False
            elif str(r.json()["authenticated"]) == "True":
                ck_insta = r.cookies.get_dict()
                uid = r.json()["userId"]
                h ={
                    'Accept':'application/json, text/plain, */*',
                    'Accept-Encoding':'gzip, deflate, br',
                    'Accept-Language':'vi',
                    'Sec-Ch-Ua':'"Not A(Brand";v="99", "Microsoft Edge";v="121", "Chromium";v="121"',
                    'Sec-Ch-Ua-Mobile':'?0',
                    'Sec-Ch-Ua-Platform':'"Windows"',
                    'Sec-Fetch-Dest':'empty',
                    'Sec-Fetch-Mode':'cors',
                    'Sec-Fetch-Site':'none',
                    'User-Agent':'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/121.0.0.0 Safari/537.36 Edg/121.0.0.0',
                    'X-Asbd-Id':'437806',
                    'X-Csrftoken':token_insta,
                    'X-Ig-App-Id':'936619743392459'
                }

                a = requests.get(f"https://i.instagram.com/api/v1/users/{uid}/info/", headers=h, cookies=ck_insta)
                frame_text_box.configure(state = "normal")
                frame_text_box.insert(customtkinter.END, f'Login thành công user {user}\n')
                frame_text_box.configure(state = "disabled")
                a = a.json()["user"]["following_count"]
                return True
            else:
                frame_text_box.configure(state = "normal")
                frame_text_box.insert(customtkinter.END, f'Tạm thời bị block, chờ 20s nhả block\n')
                frame_text_box.configure(state = "disabled")
                time.sleep(20)
        except Exception as e:
            print(str(e))
            return False

    def craw_fl_ig(user, pss, username, datestring):
        global token_insta, ck_insta
        check_acc = get_cookie(user, pss)
        if check_acc == True:
            frame_text_box.configure(state = "normal")
            frame_text_box.insert(customtkinter.END, f'Login thành công user {user}\n')
            frame_text_box.configure(state = "disabled")
            h ={
                        'Accept':'application/json, text/plain, */*',
                        'Accept-Encoding':'gzip, deflate, br',
                        'Accept-Language':'vi',
                        'Sec-Ch-Ua':'"Not A(Brand";v="99", "Microsoft Edge";v="121", "Chromium";v="121"',
                        'Sec-Ch-Ua-Mobile':'?0',
                        'Sec-Ch-Ua-Platform':'"Windows"',
                        'Sec-Fetch-Dest':'empty',
                        'Sec-Fetch-Mode':'cors',
                        'Sec-Fetch-Site':'none',
                        'User-Agent':'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/121.0.0.0 Safari/537.36 Edg/121.0.0.0',
                        'X-Asbd-Id':'437806',
                        'X-Csrftoken':token_insta,
                        'X-Ig-App-Id':'936619743392459'
                    }
            uid = requests.get(f"https://i.instagram.com/api/v1/users/web_profile_info/?username={username}", cookies=ck_insta, headers=h).json()["data"]["user"]["id"]
            url = f"https://www.instagram.com/graphql/query/?query_hash=58712303d941c6855d4e888c5f0cd22f&variables=%7B%22id%22:%22{uid}%22,%22first%22:50,%22after%22:%22%22%7D"
            if os.path.exists("save.json"):
                with open("save.json", "r", encoding="utf-8") as json_file:
                    try:
                        save_list = json.load(json_file)
                        if save_list["username"] == username:
                            save_list = save_list["ids"]
                            list_id_following = list(set(list_id_following)-set(save_list))
                    except: save_list = []
            else:
                open("save.json", "a", encoding="utf-8")
                save_list = []
            while True:
                list_infor = requests.get(url, cookies=ck_insta)
                if ("Please wait a few minutes before you try again." in list_infor.text) == False:
                    try:
                        list_infor = list_infor.json()
                        b = list_infor["data"]["user"]["edge_follow"]["edges"]
                        for i in b:
                            print(len(b))
                            iid = i["node"]["id"]
                            if (iid in save_list) == False:
                                username_following = i["node"]["username"]
                                fullname = i["node"]["full_name"]
                                avt_pic = i["node"]["profile_pic_url"]
                                is_verified = i["node"]["is_verified"]
                                followed_by_viewer = i["node"]["followed_by_viewer"]
                                list_id_following = [iid, username_following, fullname, avt_pic, followed_by_viewer, is_verified]
                                uidd = iid
                                h ={
                                'Accept':'application/json, text/plain, */*',
                                'Accept-Encoding':'gzip, deflate, br',
                                'Accept-Language':'vi',
                                'Sec-Ch-Ua':'"Not A(Brand";v="99", "Microsoft Edge";v="121", "Chromium";v="121"',
                                'Sec-Ch-Ua-Mobile':'?0',
                                'Sec-Ch-Ua-Platform':'"Windows"',
                                'Sec-Fetch-Dest':'empty',
                                'Sec-Fetch-Mode':'cors',
                                'Sec-Fetch-Site':'none',
                                'User-Agent':'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/121.0.0.0 Safari/537.36 Edg/121.0.0.0',
                                'X-Asbd-Id':'437806',
                                'X-Csrftoken':token_insta,
                                'X-Ig-App-Id':'936619743392459'
                                }

                                a = requests.get(f"https://i.instagram.com/api/v1/users/{uidd}/info/", headers=h, cookies=ck_insta).json()
                                try:
                                    public_email = a["user"]["public_email"]
                                except: public_email = ""
                                try:
                                    public_phone_country_code = a["user"]["public_phone_country_code"]
                                except:
                                    public_phone_country_code = ""
                                try:
                                    public_phone_number = a["user"]["public_phone_number"]
                                except:
                                    public_phone_number = ""
                                try:
                                    city_name = a["user"]["city_name"]
                                except:
                                    city_name = ""
                                try:
                                    address_street = a["user"]["address_street"]
                                except:
                                    address_street = ""
                                wb = openpyxl.load_workbook(datestring + ".xlsx")
                                ws = wb.active
                                try:
                                    ii = [list_id_following[0], list_id_following[1], list_id_following[2], list_id_following[3], list_id_following[4], list_id_following[5], a["user"]["follower_count"], a["user"]["following_count"], a["user"]["biography"], public_email, a["user"]["media_count"], public_phone_country_code, public_phone_number, city_name, address_street, a["user"]["is_private"], a["user"]["is_business"], a["user"]["external_url"], f"{username}"]
                                    ws.append(ii)
                                    wb.save(datestring + ".xlsx")
                                    frame_text_box.configure(state = "normal")
                                    frame_text_box.insert(customtkinter.END, f'Crawl success user {list_id_following[1]}\n')
                                    frame_text_box.configure(state = "disabled")
                                    save_list.append(list_id_following[0])
                                    data_dict = {"username": username, "ids": save_list}
                                    with open("save.json", "w", encoding="utf-8") as json_file:
                                        json.dump(data_dict, json_file)
                                    time.sleep(int(delay.get()))
                                except Exception as e:
                                    print("Lỗi crawl: "+str(e))
                                    print(a)
                                    b.append(i)
                                    while get_cookie(user, pss)==False:
                                        time.sleep(5)
                                        frame_text_box.configure(state = "normal")
                                        frame_text_box.insert(customtkinter.END, f'Login không thành công account {user}\n')
                                        frame_text_box.configure(state = "disabled")
                                        list_userpass.remove([user, pss])
                                        aa = random.choice(list_userpass)
                                        user = aa[0]
                                        pss = aa[1]
                                        
                                    frame_text_box.configure(state = "normal")
                                    frame_text_box.insert(customtkinter.END, f'Login thành công account {user}, tiếp tục crawl details\n')
                                    frame_text_box.configure(state = "disabled")
                        if str(list_infor["data"]["user"]["edge_follow"]["page_info"]["has_next_page"]) == "True":
                            next_cursor = quote(list_infor["data"]["user"]["edge_follow"]["page_info"]["end_cursor"])
                            url = f"https://www.instagram.com/graphql/query/?query_hash=58712303d941c6855d4e888c5f0cd22f&variables=%7B%22id%22:%22{uid}%22,%22first%22:50,%22after%22:%22{next_cursor}%22%7D"
                        else:
                            break
                        time.sleep(3)
                    except:
                        print(a)
                        while get_cookie(user, pss)==False:
                                        time.sleep(5)
                                        frame_text_box.configure(state = "normal")
                                        frame_text_box.insert(customtkinter.END, f'Login không thành công account {user}\n')
                                        frame_text_box.configure(state = "disabled")
                                        list_userpass.remove([user, pss])
                                        aa = random.choice(list_userpass)
                                        user = aa[0]
                                        pss = aa[1]
                                        
                        frame_text_box.configure(state = "normal")
                        frame_text_box.insert(customtkinter.END, f'Login thành công account {user}, tiếp tục crawl details\n')
                        frame_text_box.configure(state = "disabled")
                else:
                    while get_cookie(user, pss)==False:
                                        time.sleep(5)
                                        frame_text_box.configure(state = "normal")
                                        frame_text_box.insert(customtkinter.END, f'Login không thành công account {user}\n')
                                        frame_text_box.configure(state = "disabled")
                                        list_userpass.remove([user, pss])
                                        aa = random.choice(list_userpass)
                                        user = aa[0]
                                        pss = aa[1]
                                        
                    frame_text_box.configure(state = "normal")
                    frame_text_box.insert(customtkinter.END, f'Login thành công account {user}, tiếp tục crawl details\n')
                    frame_text_box.configure(state = "disabled")
        
            frame_text_box.configure(state = "normal")
            frame_text_box.insert(customtkinter.END, f'Crawl thành công thông tin của {len(list_id_following)} ids\n')
            frame_text_box.configure(state = "disabled")
        else:
            aa = random.choice(list_userpass)
            user = aa[0]
            pss = aa[1]
            craw_fl_ig(user, pss, username, datestring)
    def runn():
        a = random.choice(list_userpass)
        print(a)
        dem = 0
        user = a[0]
        pss = a[1]
        wb = openpyxl.Workbook()
        ws = wb.active
        ws.append(['Instagram ID','Username','Full name','Avatar pic','Followed by viewer','Is verified','Followers count','Following count','Biography','Public email','Posts count','Phone country code','Phone number','City','Address','Is private','Is business','External url', "Crawl by"])
        datestring = datetime.datetime.strftime(datetime.datetime.now(), "%H-%M-%S-%d-%m-%Y ")
        wb.save(datestring + ".xlsx")
        for i in list_username:
            craw_fl_ig(user, pss, i, datestring)
            dem += 1
            if dem == int(change_account.get()):
                a = random.choice(list_userpass)
                print(a)
                dem = 0
                user = a[0]
                pss = a[1]
    print(check_status())
    if check_status():
        threading.Thread(target=runn).start()


list_username = []

def open_file_user():
    global list_username
    from tkinter import filedialog
    file_text_path = filedialog.askopenfilename(filetypes=[("Excel files", "*.xlsx")], title="Choose username file")
    if file_text_path!="":
        workbook = openpyxl.load_workbook(filename=file_text_path)
        sheet = workbook.active
        column = sheet["A"]
        for cell in column:
            list_username.append(cell.value)
        frame_text_box.configure(state = "normal")
        frame_text_box.insert(customtkinter.END, f'Import success {len(list_username)} usernames\n')
        frame_text_box.configure(state = "disabled")

list_userpass = []

def open_file_userpass():
    global list_usernamepass
    from tkinter import filedialog
    file_text_path = filedialog.askopenfilename(filetypes=[("Excel files", "*.xlsx")], title="Choose account file")
    if file_text_path!="":
        workbook = openpyxl.load_workbook(filename=file_text_path)
        sheet = workbook.active
        column = sheet["A"]
        column2 = sheet["B"]
        for cell1, cell2 in zip(column, column2):
            list_userpass.append([cell1.value, cell2.value])
        frame_text_box.configure(state = "normal")
        frame_text_box.insert(customtkinter.END, f'Import success {len(list_userpass)} account\n')
        frame_text_box.configure(state = "disabled")

infor_input = customtkinter.CTkFrame(app, width = 310)
infor_input.grid(row = 0, column = 0, padx = 20, pady = (20, 10))
delay = customtkinter.CTkEntry(infor_input, width = 150, placeholder_text="Nhập delay")
delay.grid(row = 0, column = 0, padx = (0, 5))
change_account = customtkinter.CTkEntry(infor_input, width = 150, placeholder_text="Nhập số username thay account")
change_account.grid(row = 0, column = 1, padx = (5, 0))

button_frame = customtkinter.CTkFrame(app, width = 260, height= 50)
button_frame.grid(row = 2, column = 0, pady = 10)

start_button = customtkinter.CTkButton(button_frame, width = 60, height = 50, text = 'Start', command=start)
start_button.grid(row = 0, column = 1, padx = (0,0))

stop_button = customtkinter.CTkButton(button_frame, width = 60, height = 50, text = 'Stop', command=stop)
stop_button.grid(row = 0, column = 2, padx = (10,10))

file_button = customtkinter.CTkButton(button_frame, width = 60, height = 50, text = 'Account', command=open_file_userpass)
file_button.grid(row = 0, column = 3, padx = (0,0))

file_text = customtkinter.CTkButton(button_frame, width = 70, height = 50, text = 'Username', command=open_file_user)
file_text.grid(row = 0, column = 4, padx = (10,0))

frame_text_box = customtkinter.CTkTextbox(app, width = 300, height= 220)
frame_text_box.grid(row = 4, column = 0, pady = 10)
frame_text_box.configure(state = "disabled")

app.mainloop()
